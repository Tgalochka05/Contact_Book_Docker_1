{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Список контактов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Список контактов</h1>

    <div class="mb-3">
        <a href="{% url 'contact_form' %}" class="btn btn-primary">Добавить контакт</a>
        <a href="{% url 'upload_xml' %}" class="btn btn-info">Загрузить XML</a>
        <a href="{% url 'xml_files_list' %}" class="btn btn-warning">Все XML файлы</a>
    </div>

    <!-- Форма выбора источника данных -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-auto">
                    <label class="form-label"><strong>Источник данных:</strong></label>
                </div>
                <div class="col-auto">
                    {{ source_form.source }}
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-outline-primary">Показать</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AJAX поиск -->
    {% if from_db %}
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Поиск по контактам</h5>
            <input type="text" id="search-input" class="form-control" placeholder="Введите имя, телефон, email или адрес для поиска...">
            <div id="search-results" class="mt-3"></div>
        </div>
    </div>
    {% endif %}

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
    {% endif %}

    {% if has_contacts %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ФИО</th>
                        <th>Телефон</th>
                        <th>Email</th>
                        <th>Адрес</th>
                        {% if from_db %}
                        <th>Действия</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="contacts-table-body">
                    {% for contact in contacts %}
                    <tr>
                        <td>{{ contact.name }}</td>
                        <td>{{ contact.phone }}</td>
                        <td>{{ contact.email }}</td>
                        <td>{{ contact.address|default:"-" }}</td>
                        {% if from_db %}
                        <td>
                            <a href="{% url 'edit_contact' contact.id %}" class="btn btn-sm btn-warning">Редактировать</a>
                            <a href="{% url 'delete_contact' contact.id %}" class="btn btn-sm btn-danger">Удалить</a>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">
            Контакты не найдены. <a href="{% url 'contact_form' %}">Добавить первый контакт</a>
        </div>
    {% endif %}
</div>

<!-- AJAX скрипт для поиска -->
{% if from_db %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const resultsDiv = document.getElementById('search-results');
    const tableBody = document.getElementById('contacts-table-body');
    
    // Функция для загрузки всех контактов
    function loadAllContacts() {
        fetch('?source=db')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html'); //преобразует HTML-строку в DOM-дерево
                const newTableBody = doc.getElementById('contacts-table-body');
                if (newTableBody) {
                    tableBody.innerHTML = newTableBody.innerHTML;
                }
                resultsDiv.innerHTML = '';
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    // Функция для выполнения поиска
    function performSearch(query) {
        fetch(`/ajax-search/?q=${encodeURIComponent(query)}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.contacts && data.contacts.length > 0) {
                tableBody.innerHTML = '';
                data.contacts.forEach(contact => {
                    const row = `
                        <tr>
                            <td>${contact.name}</td>
                            <td>${contact.phone}</td>
                            <td>${contact.email}</td>
                            <td>${contact.address}</td>
                            <td>
                                <a href="/edit/${contact.id}/" class="btn btn-sm btn-warning">Редактировать</a>
                                <a href="/delete/${contact.id}/" class="btn btn-sm btn-danger">Удалить</a>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                resultsDiv.innerHTML = `<div class="alert alert-success">Найдено контактов: ${data.contacts.length} по запросу "${query}"</div>`;
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Контакты не найдены</td></tr>';
                resultsDiv.innerHTML = `<div class="alert alert-warning">По запросу "${query}" контакты не найдены</div>`;
            }
        })
        .catch(error => {
            console.error('Error during search:', error);
            resultsDiv.innerHTML = '<div class="alert alert-danger">Ошибка при выполнении поиска</div>';
        });
    }
    
    // Обработчик ввода
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (query.length === 0) {
            loadAllContacts();
            return;
        }
        
        if (query.length < 2) {
            resultsDiv.innerHTML = '<div class="alert alert-info">Введите минимум 2 символа для поиска</div>';
            return;
        }
        
        // Дебаунс - ждем 300ms после последнего ввода
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    // Обработчик нажатия Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query.length >= 2) {
                performSearch(query);
            }
        }
    });
});
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>